<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Кольцевая настольная игра</title>

<style>
    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #111;
        color: #eee;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }

    h1 {
        margin-bottom: 10px;
        text-align: center;
    }

    #controls, #messages, #diceArea {
        margin-top: 15px;
        text-align: center;
        max-width: 600px;
    }

    button {
        padding: 10px 18px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 6px;
        border: none;
        background: #444;
        color: #fff;
    }

    button:disabled {
        opacity: 0.5;
        cursor: default;
    }

    /* ==== ДОСКА ==== */

    #boardWrapper {
        margin-top: 20px;
    }

    .board {
        position: relative;
        width: 420px;
        height: 420px;
        border-radius: 50%;
        background: radial-gradient(circle, #222 0%, #000 70%);
        box-shadow: 0 0 20px rgba(0,0,0,0.7);
        overflow: visible;
    }

    .ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        pointer-events: none;
    }

    .outer-ring {
        width: 100%;
        height: 100%;
    }

    .middle-ring {
        width: 70%;
        height: 70%;
    }

    .inner-ring {
        width: 40%;
        height: 40%;
    }

    .segment {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 80px;
        height: 30px;
        margin: -15px -40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #ddd;
        border-radius: 14px;
        background: rgba(0,0,0,0.4);
        border: 1px solid rgba(255,255,255,0.1);
        box-sizing: border-box;
        pointer-events: none;
    }

    .outer-seg {
        transform-origin: 50% -170px;
    }

    .middle-seg {
        transform-origin: 50% -120px;
        background: rgba(40,40,40,0.9);
    }

    .inner-seg {
        transform-origin: 50% -70px;
    }

    .segment span.symbol-text {
        pointer-events: none;
    }

    /* ФИШКИ */

    .token-white::after,
    .token-black::after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #000;
        box-shadow: 0 0 5px rgba(0,0,0,0.6);
        right: -6px;
        bottom: -6px;
    }

    .token-white::after {
        background: #f5f5f5;
    }

    .token-black::after {
        background: #111;
    }

    /* ЦЕНТРАЛЬНЫЙ ЛОГОТИП */

    .logo {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 120px;
        height: 120px;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        background: radial-gradient(circle, #555 0%, #222 60%, #000 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        text-align: center;
        font-size: 18px;
        color: #eee;
        box-shadow: 0 0 10px rgba(0,0,0,0.7);
        pointer-events: none;
    }

    /* АНИМАЦИЯ В КОНЦЕ ИГРЫ */

    .board-animate {
        animation: boardMove 1.8s ease-in-out forwards;
    }

    @keyframes boardMove {
        0% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        25% { transform: translate(-50%, -55%) scale(1.05) rotate(3deg); }
        50% { transform: translate(-50%, -50%) scale(0.95) rotate(-3deg); }
        75% { transform: translate(-50%, -45%) scale(1.08) rotate(2deg); }
        100% { transform: translate(-50%, -60%) scale(0.1) rotate(20deg); opacity: 0; }
    }

    /* ЗОНА КОНЦОВОК */

    #endingArea {
        margin-top: 30px;
        text-align: center;
        max-width: 600px;
        display: none;
    }

    #endingImage {
        max-width: 100%;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0,0,0,0.8);
        margin-bottom: 10px;
    }

    #endingText {
        font-size: 18px;
        line-height: 1.4;
    }

    #diceArea {
        font-size: 18px;
        line-height: 1.5;
    }
</style>
</head>
<body>

<h1>Кольцевая настольная игра</h1>

<div id="controls">
    <div id="colorChoice">
        Выбери цвет фишек:<br />
        <button id="playWhiteBtn">Играть белыми</button>
        <button id="playBlackBtn">Играть чёрными</button>
    </div>
    <div id="rollControls" style="display:none;">
        <button id="rollBtn">Бросить кубики</button>
    </div>
</div>

<div id="messages"></div>

<div id="diceArea">
    <div><b>Твой бросок:</b> <span id="playerDiceText">—</span></div>
    <div><b>Бросок компьютера:</b> <span id="computerDiceText">—</span></div>
</div>

<div id="boardWrapper">
    <div id="board" class="board">
        <div id="outerRing" class="ring outer-ring"></div>
        <div id="middleRing" class="ring middle-ring"></div>
        <div id="innerRing" class="ring inner-ring"></div>
        <div class="logo">ЛОГО<br/>ЦЕНТР</div>
    </div>
</div>

<div id="endingArea">
    <img id="endingImage" src="" alt="ending" />
    <div id="endingText"></div>
</div>

<script>
    /* ================================
       КОНСТАНТЫ И НАСТРОЙКИ
       ================================ */

    // 6 символов, которые есть:
    // 1) на кубиках
    // 2) на сегментах внешнего и внутреннего колец
    // 3) в парах среднего кольца
    //
    // Сейчас это простые значки; ты можешь заменить их на <img> или другие символы.
    const SYMBOLS = ["ᚯ", "ᛁ", "ᛉ", "ᛋ", "ᚻ", "ᚫ"];

    // Раскладка символов по сегментам внешнего и внутреннего колец:
    // 12 сегментов, каждый — один из 6 символов, здесь просто повторяем два раза подряд.
    const RING_SYMBOL_INDEXES = [0,1,2,3,4,5,0,1,2,3,4,5];

    // Пары символов для среднего кольца (комбинации по 2 символа).
    // Храним индексы символов из массива SYMBOLS.
    // Порядок в игре НЕ важен (♠+♥ то же самое, что ♥+♠),
    // но удобно хранить как [a, b].
    const MIDDLE_PAIRS = [
        [0,1], // ♠ + ♥
        [2,3], // ♣ + ♦
        [4,5], // ★ + ✚
        [0,2], // ♠ + ♣
        [1,3], // ♥ + ♦
        [2,4], // ♣ + ★
        [3,5], // ♦ + ✚
        [0,5], // ♠ + ✚
        [1,4], // ♥ + ★
        [0,3], // ♠ + ♦
        [1,5], // ♥ + ✚
        [2,5]  // ♣ + ✚
    ];

    // Картинки концовок:
    const FOREST_ENDING = {
        image: "images/forest.png",  // особая картинка «Лес»
        text: "Лес. Баланс. Белых и чёрных камней на среднем кольце поровну."
    };

    const RANDOM_ENDINGS = [
        { image: "images/ending1.png", text: "Вариант концовки №1." },
        { image: "images/ending2.png", text: "Вариант концовки №2." }
        // добавь сюда ещё вариантов
    ];

    /* ================================
       СОСТОЯНИЕ ИГРЫ
       ================================ */

    let phase = "chooseColor"; // "chooseColor" | "round1" | "round2" | "finished"
    let playerColor = null;    // "white" | "black"
    let computerColor = null;  // противоположный

    // Кольца: массив из 12 объектов
    // outerRing[i] = { symbolIndex: number, token: null | "white" | "black" }
    // innerRing[i] = { ... }
    // middleRing[i] = { pair: [a,b], token: null | "white" | "black" }
    let outerRing = [];
    let innerRing = [];
    let middleRing = [];

    // DOM-ссылки на сегменты для визуального обновления
    let outerSegElems = [];
    let innerSegElems = [];
    let middleSegElems = [];

    // Вторая фаза: кто ходит (используем для информационных сообщений, но сами ходы делаем парами)
    let currentTurn = "player"; // по дизайну: игрок ↔ компьютер, но мы будем кидать сразу за обоих в одной кнопке

    /* ================================
       ИНИЦИАЛИЗАЦИЯ ДОСКИ
       ================================ */

    const outerRingElem = document.getElementById("outerRing");
    const middleRingElem = document.getElementById("middleRing");
    const innerRingElem  = document.getElementById("innerRing");
    const boardElem      = document.getElementById("board");

    function createRingSegments() {
        // внешнее и внутреннее кольца: 12 сегментов с символами
        for (let i = 0; i < 12; i++) {
            const symbolIndex = RING_SYMBOL_INDEXES[i];

            // ---- ВНЕШНЕЕ КОЛЬЦО ----
            const outerSeg = document.createElement("div");
            outerSeg.className = "segment outer-seg";
            outerSeg.style.transform = `rotate(${i * 30}deg) translate(0, -170px)`;
            const outerLabel = document.createElement("span");
            outerLabel.className = "symbol-text";
            outerLabel.textContent = SYMBOLS[symbolIndex];
            outerSeg.appendChild(outerLabel);
            outerRingElem.appendChild(outerSeg);

            outerRing.push({ symbolIndex, token: null });
            outerSegElems.push(outerSeg);

            // ---- ВНУТРЕННЕЕ КОЛЬЦО ----
            const innerSeg = document.createElement("div");
            innerSeg.className = "segment inner-seg";
            innerSeg.style.transform = `rotate(${i * 30}deg) translate(0, -70px)`;
            const innerLabel = document.createElement("span");
            innerLabel.className = "symbol-text";
            innerLabel.textContent = SYMBOLS[symbolIndex];
            innerSeg.appendChild(innerLabel);
            innerRingElem.appendChild(innerSeg);

            innerRing.push({ symbolIndex, token: null });
            innerSegElems.push(innerSeg);
        }

        // ---- СРЕДНЕЕ КОЛЬЦО: пары символов ----
        for (let i = 0; i < 12; i++) {
            const pair = MIDDLE_PAIRS[i];
            const midSeg = document.createElement("div");
            midSeg.className = "segment middle-seg";
            midSeg.style.transform = `rotate(${i * 30}deg) translate(0, -120px)`;
            const midLabel = document.createElement("span");
            midLabel.className = "symbol-text";
            midLabel.textContent = SYMBOLS[pair[0]] + " " + SYMBOLS[pair[1]];
            midSeg.appendChild(midLabel);
            middleRingElem.appendChild(midSeg);

            middleRing.push({ pair: pair.slice(), token: null });
            middleSegElems.push(midSeg);
        }
    }

    createRingSegments();

    /* ================================
       УТИЛИТЫ
       ================================ */

    function randomInt(min, max) {
        // включительно
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function setMessage(text) {
        document.getElementById("messages").innerHTML = text;
    }

    function updateDiceDisplay(playerText, computerText) {
        document.getElementById("playerDiceText").textContent   = playerText;
        document.getElementById("computerDiceText").textContent = computerText;
    }

    function ringFull(ringArray) {
        return ringArray.every(cell => cell.token !== null);
    }

    function middleFull() {
        return middleRing.every(cell => cell.token !== null);
    }

    /* ================================
       РАЗМЕЩЕНИЕ ФИШЕК (РАУНД 1)
       ================================ */

    function placeTokenOnRing(color, symbolIndex) {
        const ringArray   = color === "white" ? innerRing    : outerRing;
        const segElements = color === "white" ? innerSegElems : outerSegElems;

        // ищем первый свободный сегмент с нужным символом
        for (let i = 0; i < ringArray.length; i++) {
            const cell = ringArray[i];
            if (cell.symbolIndex === symbolIndex && cell.token === null) {
                cell.token = color;
                segElements[i].classList.add(color === "white" ? "token-white" : "token-black");
                return true;
            }
        }
        // все сегменты с таким символом уже заняты — фишка "пропускает" ход
        return false;
    }

    /* ================================
       ПЕРВЫЙ РАУНД
       ================================ */

    function handleRound1Roll() {
        // игрок и компьютер бросают по одной "символьной кости"
        const playerSymIndex   = randomInt(0, SYMBOLS.length - 1);
        const computerSymIndex = randomInt(0, SYMBOLS.length - 1);

        const playerSym   = SYMBOLS[playerSymIndex];
        const computerSym = SYMBOLS[computerSymIndex];

        updateDiceDisplay(playerSym, computerSym);

        // ставим фишки
        const playerPlaced   = placeTokenOnRing(playerColor,   playerSymIndex);
        const computerPlaced = placeTokenOnRing(computerColor, computerSymIndex);

        let msg = `<b>Первый раунд.</b><br>
                   Ты бросил: ${playerSym} (${playerPlaced ? "фишка поставлена" : "подходящих полей нет"})<br>
                   Компьютер бросил: ${computerSym} (${computerPlaced ? "фишка поставлена" : "подходящих полей нет"})`;

        // Проверяем, заполнены ли оба кольца
        const outerIsFull = ringFull(outerRing);
        const innerIsFull = ringFull(innerRing);

        if (outerIsFull && innerIsFull) {
            phase = "round2";
            setMessage(msg + `<br><br><b>Оба кольца заполнены. Начинается второй раунд.</b><br>Теперь ход идёт по очереди: комбинации из двух символов закрывают сегменты среднего кольца, фишки переносятся с твоего кольца.`);
        } else {
            setMessage(msg + `<br><br>Продолжай бросать, пока оба кольца не будут полностью заполнены.`);
        }
    }

    /* ================================
       ПЕРЕНОС ФИШКИ НА СРЕДНЕЕ КОЛЬЦО (РАУНД 2)
       ================================ */

    function removeOneTokenFromRing(color) {
        const ringArray   = color === "white" ? innerRing    : outerRing;
        const segElements = color === "white" ? innerSegElems : outerSegElems;

        for (let i = 0; i < ringArray.length; i++) {
            const cell = ringArray[i];
            if (cell.token === color) {
                cell.token = null;
                segElements[i].classList.remove(color === "white" ? "token-white" : "token-black");
                return true;
            }
        }
        return false; // вдруг нет фишек (теоретически не должно случиться до заполнения среднего кольца)
    }

    function placeTokenOnMiddle(color, s1Index, s2Index) {
        // комбинация считается неупорядоченной: (a,b) = (b,a)
        const a = s1Index;
        const b = s2Index;

        for (let i = 0; i < middleRing.length; i++) {
            const cell = middleRing[i];
            if (cell.token !== null) continue; // уже закрыто

            const p0 = cell.pair[0];
            const p1 = cell.pair[1];

            const match = (p0 === a && p1 === b) || (p0 === b && p1 === a);
            if (match) {
                // переносим фишку с "своего" кольца
                const removed = removeOneTokenFromRing(color);
                if (!removed) {
                    // нет фишек на своих кольцах — по идее, такое состояние не должно возникать до конца игры
                    return { success: false, reason: "no_tokens_on_ring" };
                }
                cell.token = color;
                middleSegElems[i].classList.add(color === "white" ? "token-white" : "token-black");
                return { success: true, index: i };
            }
        }
        return { success: false, reason: "no_such_pair_or_already_closed" };
    }

    /* ================================
       ВТОРОЙ РАУНД
       ================================ */

    function handleRound2Roll() {
        if (phase !== "round2") return;

        // Один цикл кнопки: сначала бросок игрока, потом (если игра не окончена) — автоматический бросок компьютера

        // ---- ХОД ИГРОКА ----
        const p1 = randomInt(0, SYMBOLS.length - 1);
        const p2 = randomInt(0, SYMBOLS.length - 1);
        const playerText = SYMBOLS[p1] + " + " + SYMBOLS[p2];

        let log = `<b>Второй раунд.</b><br>Твой бросок: ${playerText}`;

        const resultPlayer = placeTokenOnMiddle(playerColor, p1, p2);
        if (resultPlayer.success) {
            log += `<br>Комбинация найдена на среднем кольце — твоя фишка перенесена с твоего кольца.`;
        } else {
            log += `<br>Подходящей незакрытой комбинации на среднем кольце нет — ход переходит компьютеру.`;
        }

        updateDiceDisplay(playerText, "—");
        setMessage(log);

        if (middleFull()) {
            finishGame();
            return;
        }

        // ---- ХОД КОМПЬЮТЕРА (автоматически) ----
        setTimeout(() => {
            const c1 = randomInt(0, SYMBOLS.length - 1);
            const c2 = randomInt(0, SYMBOLS.length - 1);
            const compText = SYMBOLS[c1] + " + " + SYMBOLS[c2];

            let log2 = document.getElementById("messages").innerHTML;
            log2 += `<br><br>Ход компьютера: ${compText}`;

            const resultComp = placeTokenOnMiddle(computerColor, c1, c2);
            if (resultComp.success) {
                log2 += `<br>Комбинация найдена — фишка компьютера перенесена с его кольца.`;
            } else {
                log2 += `<br>Для компьютера тоже нет доступной комбинации. Ход возвращается тебе.`;
            }

            updateDiceDisplay(playerText, compText);
            setMessage(log2);

            if (middleFull()) {
                finishGame();
                return;
            }
        }, 600);
    }

    /* ================================
       ЗАВЕРШЕНИЕ ИГРЫ И КОНЦОВКИ
       ================================ */

    function finishGame() {
        phase = "finished";
        document.getElementById("rollBtn").disabled = true;

        // считаем фишки на среднем кольце
        let whiteCount = 0;
        let blackCount = 0;
        for (const cell of middleRing) {
            if (cell.token === "white") whiteCount++;
            if (cell.token === "black") blackCount++;
        }

        // анимация доски
        boardElem.style.transition = "transform 0s"; // сбрасываем
        // добавляем класс анимации к средней точке (через translate в CSS)
        document.querySelector(".outer-ring").style.transform = "translate(-50%, -50%)";
        document.querySelector(".middle-ring").style.transform = "translate(-50%, -50%)";
        document.querySelector(".inner-ring").style.transform  = "translate(-50%, -50%)";

        boardElem.classList.add("board-animate");
        setMessage(`<b>Все сегменты среднего кольца закрыты.</b><br>Белых фишек: ${whiteCount}, чёрных фишек: ${blackCount}.<br>Доска уходит — дальше тебя ждёт видение.`);

        setTimeout(() => {
            boardElem.style.display = "none";
            showEnding(whiteCount, blackCount);
        }, 1900);
    }

    function showEnding(whiteCount, blackCount) {
        const endingArea = document.getElementById("endingArea");
        const imgEl = document.getElementById("endingImage");
        const textEl = document.getElementById("endingText");
        endingArea.style.display = "block";

        function showForestThenRandom() {
            // сначала ЛЕС
            imgEl.src = FOREST_ENDING.image;
            textEl.textContent = FOREST_ENDING.text;

            // через пару секунд — рандомная концовка
            setTimeout(() => {
                const random = RANDOM_ENDINGS[Math.floor(Math.random() * RANDOM_ENDINGS.length)];
                imgEl.src = random.image;
                textEl.textContent = random.text;
            }, 2500);
        }

        function showRandomOnly() {
            const random = RANDOM_ENDINGS[Math.floor(Math.random() * RANDOM_ENDINGS.length)];
            imgEl.src = random.image;
            textEl.textContent = random.text;
        }

        if (whiteCount === blackCount) {
            // особый случай: баланс → Лес, затем случайная концовка
            showForestThenRandom();
        } else {
            showRandomOnly();
        }
    }

    /* ================================
       ВЫБОР ЦВЕТА / НАЧАЛО ИГРЫ
       ================================ */

    document.getElementById("playWhiteBtn").addEventListener("click", () => {
        if (phase !== "chooseColor") return;
        playerColor = "white";
        computerColor = "black";
        phase = "round1";
        document.getElementById("colorChoice").style.display = "none";
        document.getElementById("rollControls").style.display = "block";
        setMessage(`Ты играешь <b>белыми</b> (внутреннее кольцо). Компьютер — чёрными (внешнее кольцо).<br><br>Первый раунд: вы с компьютером бросаете по одному кубику с символами. На выпавшем символе каждый ставит фишку на своё кольцо. Раунд продолжается, пока оба кольца не будут заполнены.`);
    });

    document.getElementById("playBlackBtn").addEventListener("click", () => {
        if (phase !== "chooseColor") return;
        playerColor = "black";
        computerColor = "white";
        phase = "round1";
        document.getElementById("colorChoice").style.display = "none";
        document.getElementById("rollControls").style.display = "block";
        setMessage(`Ты играешь <b>чёрными</b> (внешнее кольцо). Компьютер — белыми (внутреннее кольцо).<br><br>Первый раунд: вы с компьютером бросаете по одному кубику с символами. На выпавшем символе каждый ставит фишку на своё кольцо. Раунд продолжается, пока оба кольца не будут заполнены.`);
    });

    document.getElementById("rollBtn").addEventListener("click", () => {
        if (phase === "round1") {
            handleRound1Roll();
        } else if (phase === "round2") {
            handleRound2Roll();
        }
    });

    // стартовое сообщение
    setMessage("Добро пожаловать. Сначала выбери цвет фишек, чтобы начать игру.");
</script>

</body>
</html>
